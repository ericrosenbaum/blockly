<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: JS Interpreter</title>
  <script src="acorn_interpreter.js"></script>
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks_compressed.js"></script>
  <script src="../../javascript_compressed.js"></script>
  <script src="../../msg/js/en.js"></script>

  <!-- added by ericr -->
  <script src="../../blocks/synth.js"></script>
  <script src="../../generators/javascript/synth.js"></script>
  <script src="Tone.js"></script>
 
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
  </style>
</head>
<body>

  <div id="blocklyDiv" style="height: 600px; width: 1000px;"></div>

  <p>
    <button style="height:50px;width:200px" onclick="runCode()">Run</button>
  </p>

  <p>
    <button onclick="loadDemo('simpleDemo')">simple demo</button>
    <button onclick="loadDemo('beatDemo')">drum beat demo</button>
    <button onclick="loadDemo('variableDemo')">variable demo</button>
    <button onclick="loadDemo('functionDemo')">function demo</button>
    <button onclick="loadDemo('multivoiceDemo')">multiple voices</button>
    <button onclick="loadDemo('comboDemo')">combo demo</button>
    <button onclick="loadDemo('doubleUpDrumsDemo')">double it up, yo</button>
  </p>

  <xml id="simpleDemo" style="display: none">
    <block type="controls_repeat_ext" id="46" x="127" y="8"><value name="TIMES"><block type="math_number" id="47"><field name="NUM">2</field></block></value><statement name="DO"><block type="synth_play_note" id="48"><value name="pitch"><block type="math_number" id="49"><field name="NUM">60</field></block></value><value name="duration"><block type="math_number" id="50"><field name="NUM">2</field></block></value><next><block type="synth_play_note" id="51"><value name="pitch"><block type="math_number" id="52"><field name="NUM">64</field></block></value><value name="duration"><block type="math_number" id="53"><field name="NUM">2</field></block></value><next><block type="synth_play_note" id="54"><value name="pitch"><block type="math_number" id="55"><field name="NUM">67</field></block></value><value name="duration"><block type="math_number" id="56"><field name="NUM">2</field></block></value><next><block type="synth_play_note" id="57"><value name="pitch"><block type="math_number" id="58"><field name="NUM">71</field></block></value><value name="duration"><block type="math_number" id="59"><field name="NUM">2</field></block></value></block></next></block></next></block></next></block></statement><next><block type="synth_play_note" id="60"><value name="pitch"><block type="math_number" id="61"><field name="NUM">72</field></block></value><value name="duration"><block type="math_number" id="62"><field name="NUM">4</field></block></value></block></next></block>
  </xml>

  <xml id="beatDemo" style="display: none">
    <block type="controls_repeat_ext" id="1" x="32" y="11"><value name="TIMES"><block type="math_number" id="2"><field name="NUM">2</field></block></value><statement name="DO"><block type="synth_play_drum" id="3"><field name="NAME">KICK</field><value name="duration"><block type="math_number" id="4"><field name="NUM">8</field></block></value><next><block type="synth_play_drum" id="5"><field name="NAME">SNARE</field><value name="duration"><block type="math_number" id="6"><field name="NUM">6</field></block></value><next><block type="synth_play_drum" id="7"><field name="NAME">KICK</field><value name="duration"><block type="math_number" id="8"><field name="NUM">2</field></block></value><next><block type="synth_play_drum" id="9"><field name="NAME">KICK</field><value name="duration"><block type="math_number" id="10"><field name="NUM">8</field></block></value><next><block type="synth_play_drum" id="11"><field name="NAME">SNARE</field><value name="duration"><block type="math_number" id="12"><field name="NUM">8</field></block></value></block></next></block></next></block></next></block></next></block></statement></block><block type="controls_repeat_ext" id="13" x="378" y="9"><value name="TIMES"><block type="math_number" id="14"><field name="NUM">2</field></block></value><statement name="DO"><block type="controls_repeat_ext" id="37"><value name="TIMES"><block type="math_number" id="38"><field name="NUM">12</field></block></value><statement name="DO"><block type="synth_play_drum" id="15"><field name="NAME">HIHAT</field><value name="duration"><block type="math_number" id="16"><field name="NUM">2</field></block></value></block></statement><next><block type="controls_repeat_ext" id="20"><value name="TIMES"><block type="math_number" id="21"><field name="NUM">4</field></block></value><statement name="DO"><block type="synth_play_drum" id="32"><field name="NAME">SCRATCH</field><value name="duration"><block type="math_number" id="33"><field name="NUM">1</field></block></value></block></statement><next><block type="controls_repeat_ext" id="39"><value name="TIMES"><block type="math_number" id="40"><field name="NUM">8</field></block></value><statement name="DO"><block type="synth_play_drum" id="41"><field name="NAME">SCRATCH</field><value name="duration"><block type="math_number" id="42"><field name="NUM">0.5</field></block></value></block></statement></block></next></block></next></block></statement></block>
  </xml>

  <xml id="variableDemo" style="display: none">
    <block type="variables_set" id="63" x="120" y="20"><field name="VAR">frequency</field><value name="VALUE"><block type="math_number" id="64"><field name="NUM">50</field></block></value><next><block type="controls_repeat_ext" id="65"><value name="TIMES"><block type="math_number" id="66"><field name="NUM">24</field></block></value><statement name="DO"><block type="synth_play_freq" id="67"><value name="freq"><block type="variables_get" id="68"><field name="VAR">frequency</field></block></value><value name="duration"><block type="math_number" id="69"><field name="NUM">1</field></block></value><next><block type="variables_set" id="70"><field name="VAR">frequency</field><value name="VALUE"><block type="math_arithmetic" id="71"><field name="OP">ADD</field><value name="A"><block type="variables_get" id="72"><field name="VAR">frequency</field></block></value><value name="B"><block type="math_number" id="73"><field name="NUM">50</field></block></value></block></value></block></next></block></statement></block></next></block>
  </xml>

  <xml id="functionDemo" style="display: none">
    <block type="variables_set" id="74" x="150" y="30"><field name="VAR">counter</field><value name="VALUE"><block type="math_number" id="75"><field name="NUM">2</field></block></value><next><block type="controls_repeat_ext" id="76"><value name="TIMES"><block type="math_number" id="77"><field name="NUM">6</field></block></value><statement name="DO"><block type="procedures_callnoreturn" id="78"><mutation name="up"><arg name="times"></arg></mutation><value name="ARG0"><block type="variables_get" id="79"><field name="VAR">counter</field></block></value><next><block type="variables_set" id="80"><field name="VAR">counter</field><value name="VALUE"><block type="math_arithmetic" id="81"><field name="OP">ADD</field><value name="A"><block type="variables_get" id="82"><field name="VAR">counter</field></block></value><value name="B"><block type="math_number" id="83"><field name="NUM">1</field></block></value></block></value></block></next></block></statement></block></next></block><block type="procedures_defnoreturn" id="84" x="157" y="215"><mutation><arg name="times"></arg></mutation><field name="NAME">up</field><statement name="STACK"><block type="variables_set" id="85"><field name="VAR">note</field><value name="VALUE"><block type="math_number" id="86"><field name="NUM">72</field></block></value><next><block type="controls_repeat_ext" id="87"><value name="TIMES"><block type="variables_get" id="88"><field name="VAR">times</field></block></value><statement name="DO"><block type="synth_play_note" id="89"><value name="pitch"><block type="variables_get" id="90"><field name="VAR">note</field></block></value><value name="duration"><block type="math_number" id="91"><field name="NUM">1</field></block></value><next><block type="variables_set" id="92"><field name="VAR">note</field><value name="VALUE"><block type="math_arithmetic" id="93"><field name="OP">MINUS</field><value name="A"><block type="variables_get" id="94"><field name="VAR">note</field></block></value><value name="B"><block type="math_number" id="95"><field name="NUM">2</field></block></value></block></value></block></next></block></statement></block></next></block></statement></block>
  </xml>

  <xml id="doubleUpDemo" style="display: none">
    <block type="synth_play_note" id="130" x="161" y="30"><value name="pitch"><block type="math_number" id="131"><field name="NUM">72</field></block></value><value name="duration"><block type="math_number" id="132"><field name="NUM">2</field></block></value><next><block type="synth_play_note" id="133"><value name="pitch"><block type="math_number" id="134"><field name="NUM">67</field></block></value><value name="duration"><block type="math_number" id="135"><field name="NUM">2</field></block></value><next><block type="synth_play_note" id="136"><value name="pitch"><block type="math_number" id="137"><field name="NUM">63</field></block></value><value name="duration"><block type="math_number" id="138"><field name="NUM">2</field></block></value><next><block type="synth_play_note" id="139"><value name="pitch"><block type="math_number" id="140"><field name="NUM">62</field></block></value><value name="duration"><block type="math_number" id="141"><field name="NUM">2</field></block></value><next><block type="variables_set" id="142"><field name="VAR">counter</field><value name="VALUE"><block type="math_number" id="143"><field name="NUM">1</field></block></value><next><block type="controls_repeat_ext" id="144"><value name="TIMES"><block type="math_number" id="145"><field name="NUM">4</field></block></value><statement name="DO"><block type="controls_repeat_ext" id="146"><value name="TIMES"><block type="variables_get" id="147"><field name="VAR">counter</field></block></value><statement name="DO"><block type="synth_play_note" id="148"><value name="pitch"><block type="math_arithmetic" id="149"><field name="OP">MINUS</field><value name="A"><block type="math_number" id="150"><field name="NUM">61</field></block></value><value name="B"><block type="variables_get" id="151"><field name="VAR">counter</field></block></value></block></value><value name="duration"><block type="math_arithmetic" id="152"><field name="OP">DIVIDE</field><value name="A"><block type="math_number" id="153"><field name="NUM">8</field></block></value><value name="B"><block type="variables_get" id="154"><field name="VAR">counter</field></block></value></block></value></block></statement><next><block type="variables_set" id="155"><field name="VAR">counter</field><value name="VALUE"><block type="math_arithmetic" id="156"><field name="OP">MULTIPLY</field><value name="A"><block type="variables_get" id="157"><field name="VAR">counter</field></block></value><value name="B"><block type="math_number" id="158"><field name="NUM">2</field></block></value></block></value></block></next></block></statement></block></next></block></next></block></next></block></next></block></next></block>
  </xml>

  <xml id="multivoiceDemo" style="display: none">
    <block type="synth_set_instrument" id="124" x="58" y="21"><field name="NAME">ORGAN</field><next><block type="controls_repeat_ext" id="99"><value name="TIMES"><block type="math_number" id="100"><field name="NUM">2</field></block></value><statement name="DO"><block type="synth_play_note" id="101"><value name="pitch"><block type="math_number" id="102"><field name="NUM">72</field></block></value><value name="duration"><block type="math_number" id="103"><field name="NUM">4</field></block></value><next><block type="synth_play_note" id="104"><value name="pitch"><block type="math_number" id="105"><field name="NUM">76</field></block></value><value name="duration"><block type="math_number" id="106"><field name="NUM">4</field></block></value><next><block type="synth_play_note" id="107"><value name="pitch"><block type="math_number" id="108"><field name="NUM">79</field></block></value><value name="duration"><block type="math_number" id="109"><field name="NUM">4</field></block></value><next><block type="synth_play_note" id="110"><value name="pitch"><block type="math_number" id="111"><field name="NUM">83</field></block></value><value name="duration"><block type="math_number" id="112"><field name="NUM">4</field></block></value></block></next></block></next></block></next></block></statement><next><block type="synth_play_note" id="67"><value name="pitch"><block type="math_number" id="68"><field name="NUM">84</field></block></value><value name="duration"><block type="math_number" id="69"><field name="NUM">4</field></block></value></block></next></block></next></block><block type="synth_set_instrument" id="98" x="374" y="22"><field name="NAME">SYNTH</field><next><block type="controls_repeat_ext" id="70"><value name="TIMES"><block type="math_number" id="71"><field name="NUM">4</field></block></value><statement name="DO"><block type="synth_play_note" id="72"><value name="pitch"><block type="math_number" id="73"><field name="NUM">72</field></block></value><value name="duration"><block type="math_number" id="74"><field name="NUM">2</field></block></value><next><block type="synth_play_note" id="75"><value name="pitch"><block type="math_number" id="76"><field name="NUM">76</field></block></value><value name="duration"><block type="math_number" id="77"><field name="NUM">2</field></block></value><next><block type="synth_play_note" id="78"><value name="pitch"><block type="math_number" id="79"><field name="NUM">79</field></block></value><value name="duration"><block type="math_number" id="80"><field name="NUM">2</field></block></value><next><block type="synth_play_note" id="81"><value name="pitch"><block type="math_number" id="82"><field name="NUM">83</field></block></value><value name="duration"><block type="math_number" id="83"><field name="NUM">2</field></block></value></block></next></block></next></block></next></block></statement><next><block type="synth_play_note" id="84"><value name="pitch"><block type="math_number" id="85"><field name="NUM">84</field></block></value><value name="duration"><block type="math_number" id="86"><field name="NUM">4</field></block></value></block></next></block></next></block>
  </xml>

  <xml id="drumsDemo" style="display: none">
    <block type="synth_rest" id="77" x="140" y="10"><value name="duration"><block type="math_number" id="78"><field name="NUM">2</field></block></value><next><block type="controls_repeat_ext" id="43"><value name="TIMES"><block type="math_number" id="44"><field name="NUM">8</field></block></value><statement name="DO"><block type="synth_play_drum" id="28"><field name="NAME">HIHAT</field><value name="duration"><block type="math_number" id="29"><field name="NUM">0.25</field></block></value></block></statement></block></next></block><block type="controls_repeat_ext" id="45" x="142" y="178"><value name="TIMES"><block type="math_number" id="46"><field name="NUM">4</field></block></value><statement name="DO"><block type="synth_play_drum" id="47"><field name="NAME">KICK</field><value name="duration"><block type="math_number" id="48"><field name="NUM">0.5</field></block></value><next><block type="synth_play_drum" id="63"><field name="NAME">SNARE</field><value name="duration"><block type="math_number" id="64"><field name="NUM">0.5</field></block></value></block></next></block></statement></block>
  </xml>

  <xml id="comboDemo" style="display: none">
    <block type="controls_repeat_ext" id="139" x="131" y="8"><value name="TIMES"><block type="math_number" id="140"><field name="NUM">8</field></block></value><statement name="DO"><block type="synth_play_drum" id="141"><field name="NAME">KICK</field><value name="duration"><block type="math_number" id="142"><field name="NUM">1</field></block></value><next><block type="synth_play_drum" id="143"><field name="NAME">KICK</field><value name="duration"><block type="math_number" id="144"><field name="NUM">1</field></block></value><next><block type="synth_rest" id="145"><value name="duration"><block type="math_number" id="146"><field name="NUM">2</field></block></value><next><block type="synth_play_drum" id="147"><field name="NAME">SNARE</field><value name="duration"><block type="math_number" id="148"><field name="NUM">1</field></block></value><next><block type="synth_rest" id="149"><value name="duration"><block type="math_number" id="150"><field name="NUM">1</field></block></value><next><block type="synth_play_drum" id="151"><field name="NAME">KICK</field><value name="duration"><block type="math_number" id="152"><field name="NUM">2</field></block></value></block></next></block></next></block></next></block></next></block></next></block></statement><next><block type="synth_play_drum" id="153"><field name="NAME">KICK</field><value name="duration"><block type="math_number" id="154"><field name="NUM">2</field></block></value></block></next></block><block type="controls_repeat_ext" id="155" x="456" y="8"><value name="TIMES"><block type="math_number" id="156"><field name="NUM">2</field></block></value><statement name="DO"><block type="synth_rest" id="157"><value name="duration"><block type="math_number" id="158"><field name="NUM">16</field></block></value><next><block type="controls_repeat_ext" id="159"><value name="TIMES"><block type="math_number" id="160"><field name="NUM">8</field></block></value><statement name="DO"><block type="synth_play_drum" id="161"><field name="NAME">HIHAT</field><value name="duration"><block type="math_number" id="162"><field name="NUM">0.5</field></block></value></block></statement><next><block type="controls_repeat_ext" id="163"><value name="TIMES"><block type="math_number" id="164"><field name="NUM">12</field></block></value><statement name="DO"><block type="synth_play_drum" id="165"><field name="NAME">HIHAT</field><value name="duration"><block type="math_number" id="166"><field name="NUM">1</field></block></value></block></statement></block></next></block></next></block></statement></block><block type="synth_rest" id="180" x="467" y="300"><value name="duration"><block type="math_number" id="181"><field name="NUM">32</field></block></value><next><block type="controls_repeat_ext" id="182"><value name="TIMES"><block type="math_number" id="183"><field name="NUM">2</field></block></value><statement name="DO"><block type="synth_rest" id="184"><value name="duration"><block type="math_number" id="185"><field name="NUM">12</field></block></value><next><block type="controls_repeat_ext" id="186"><value name="TIMES"><block type="math_number" id="187"><field name="NUM">2</field></block></value><statement name="DO"><block type="synth_play_note" id="188"><value name="pitch"><block type="math_number" id="189"><field name="NUM">67</field></block></value><value name="duration"><block type="math_number" id="190"><field name="NUM">1</field></block></value><next><block type="synth_play_note" id="191"><value name="pitch"><block type="math_number" id="192"><field name="NUM">63</field></block></value><value name="duration"><block type="math_number" id="193"><field name="NUM">1</field></block></value></block></next></block></statement></block></next></block></statement></block></next></block><block type="synth_rest" id="167" x="143" y="343"><value name="duration"><block type="math_number" id="168"><field name="NUM">32</field></block></value><next><block type="synth_set_instrument" id="205"><field name="NAME">SYNTH</field><next><block type="controls_repeat_ext" id="239"><value name="TIMES"><block type="math_number" id="240"><field name="NUM">2</field></block></value><statement name="DO"><block type="synth_play_note" id="171"><value name="pitch"><block type="math_number" id="172"><field name="NUM">58</field></block></value><value name="duration"><block type="math_number" id="173"><field name="NUM">4</field></block></value><next><block type="synth_play_note" id="219"><value name="pitch"><block type="math_number" id="220"><field name="NUM">60</field></block></value><value name="duration"><block type="math_number" id="221"><field name="NUM">12</field></block></value></block></next></block></statement></block></next></block></next></block></xml>

<xml id="doubleUpDrumsDemo" style="display: none">
  <block type="synth_set_instrument" id="280" x="30" y="10"><field name="NAME">SYNTH</field><next><block type="synth_play_note" id="218"><value name="pitch"><block type="math_number" id="219"><field name="NUM">72</field></block></value><value name="duration"><block type="math_number" id="220"><field name="NUM">3</field></block></value><next><block type="synth_play_note" id="221"><value name="pitch"><block type="math_number" id="222"><field name="NUM">67</field></block></value><value name="duration"><block type="math_number" id="223"><field name="NUM">3</field></block></value><next><block type="synth_play_note" id="224"><value name="pitch"><block type="math_number" id="225"><field name="NUM">63</field></block></value><value name="duration"><block type="math_number" id="226"><field name="NUM">3</field></block></value><next><block type="synth_play_note" id="227"><value name="pitch"><block type="math_number" id="228"><field name="NUM">62</field></block></value><value name="duration"><block type="math_number" id="229"><field name="NUM">3</field></block></value><next><block type="controls_repeat_ext" id="230"><value name="TIMES"><block type="math_number" id="231"><field name="NUM">4</field></block></value><statement name="DO"><block type="synth_play_note" id="232"><value name="pitch"><block type="math_number" id="233"><field name="NUM">48</field></block></value><value name="duration"><block type="math_number" id="234"><field name="NUM">6</field></block></value><next><block type="controls_repeat_ext" id="235"><value name="TIMES"><block type="math_number" id="236"><field name="NUM">3</field></block></value><statement name="DO"><block type="synth_play_note" id="237"><value name="pitch"><block type="math_number" id="238"><field name="NUM">60</field></block></value><value name="duration"><block type="math_number" id="239"><field name="NUM">2</field></block></value></block></statement></block></next></block></statement><next><block type="synth_play_note" id="240"><value name="pitch"><block type="math_number" id="241"><field name="NUM">48</field></block></value><value name="duration"><block type="math_number" id="242"><field name="NUM">6</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block><block type="variables_set" id="243" x="363" y="13"><field name="VAR">counter</field><value name="VALUE"><block type="math_number" id="244"><field name="NUM">1</field></block></value><next><block type="controls_repeat_ext" id="245"><value name="TIMES"><block type="math_number" id="246"><field name="NUM">4</field></block></value><statement name="DO"><block type="controls_repeat_ext" id="247"><value name="TIMES"><block type="variables_get" id="248"><field name="VAR">counter</field></block></value><statement name="DO"><block type="synth_play_drum" id="249"><field name="NAME">SNARE</field><value name="duration"><block type="math_arithmetic" id="250"><field name="OP">DIVIDE</field><value name="A"><block type="math_number" id="251"><field name="NUM">3</field></block></value><value name="B"><block type="variables_get" id="252"><field name="VAR">counter</field></block></value></block></value></block></statement><next><block type="variables_set" id="253"><field name="VAR">counter</field><value name="VALUE"><block type="math_arithmetic" id="254"><field name="OP">MULTIPLY</field><value name="A"><block type="variables_get" id="255"><field name="VAR">counter</field></block></value><value name="B"><block type="math_number" id="256"><field name="NUM">2</field></block></value></block></value></block></next></block></statement><next><block type="controls_repeat_ext" id="257"><value name="TIMES"><block type="math_number" id="258"><field name="NUM">8</field></block></value><statement name="DO"><block type="synth_play_drum" id="259"><field name="NAME">KICK</field><value name="duration"><block type="math_number" id="260"><field name="NUM">6</field></block></value></block></statement></block></next></block></next></block><block type="synth_rest" id="261" x="367" y="354"><value name="duration"><block type="math_number" id="262"><field name="NUM">12</field></block></value><next><block type="controls_repeat_ext" id="263"><value name="TIMES"><block type="math_number" id="264"><field name="NUM">4</field></block></value><statement name="DO"><block type="controls_repeat_ext" id="265"><value name="TIMES"><block type="math_number" id="266"><field name="NUM">4</field></block></value><statement name="DO"><block type="synth_play_drum" id="267"><field name="NAME">SNARE</field><value name="duration"><block type="math_number" id="268"><field name="NUM">3</field></block></value></block></statement></block></statement></block></next></block>
</xml>

  <xml id="toolbox" style="display: none">
    <category name="Sound">

      <block type="synth_play_note">
        <value name="pitch">
          <block type="math_number">
            <field name="NUM">60</field>
          </block>
        </value>
        <value name="duration">
          <block type="math_number">
            <field name="NUM">2</field>
          </block>
        </value>
      </block>

      <block type="synth_play_freq">
        <value name="freq">
          <block type="math_number">
            <field name="NUM">200</field>
          </block>
        </value>
        <value name="duration">
          <block type="math_number">
            <field name="NUM">2</field>
          </block>
        </value>
      </block>

      <block type="synth_rest">
        <value name="duration">
          <block type="math_number">
            <field name="NUM">2</field>
          </block>
        </value>
      </block>

      <block type="synth_play_drum">
        <value name="duration">
          <block type="math_number">
            <field name="NUM">2</field>
          </block>
        </value>
      </block>

      <block type="synth_set_instrument"></block>

    </category>
    <category name="Logic">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>

    <category name="Loops">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">4</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
    </category>

    <category name="Math">
      <block type="math_number"></block>
      <block type="math_random_int">
        <value name="FROM">
          <block type="math_number">
            <field name="NUM">0</field>
          </block>
        </value>
        <value name="TO">
          <block type="math_number">
            <field name="NUM">8</field>
          </block>
        </value>

      </block>
      <block type="math_change"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
    </category>

    <category name="Variables" custom="VARIABLE"></category>
    <category name="Functions" custom="PROCEDURE"></category>
  </xml>

  <script>

    // SYNTH SETUP
    // Tone PolySynth does not use voice-stealing, so if we try to play more
    // notes at a time than we have voices, no new notes will play
    // longer release times sound nice but exacerbate this problem
    var tone = new Tone();

    // Lead synth sound
    var synth = new Tone.PolySynth(16, Tone.SimpleSynth).toMaster();
    synth.set({
      oscillator: {
        type:'pwm',
        modulationFrequency: 1
      },
      envelope:{
        release: 0
      }
    });
    synth.volume.value = -12;

    // organ sound
    var organ = new Tone.PolySynth(16, Tone.SimpleFM).toMaster();
    organ.set({
      "modulationIndex" : 12.22,
      envelope: {
        release: 0
      }
    });

    // Snare drum
    var snare = new Tone.NoiseSynth().toMaster();
    snare.set({
      envelope:{
        attack:0.005
      },
      filterEnvelope:{
        release:0,
        min:1000,
        max:500,
        exponent:2
        }
      });
    snare.volume.value = -6;


    // Kick drum
    var kick = new Tone.DrumSynth({
      envelope : {
        sustain : 0,
        attack : 0.02,
        decay : 0.5
      },
      octaves : 10
    }).toMaster();
    kick.volume.value = -3;

    // hi-hat
    var hihat = new Tone.NoiseSynth().toMaster();
    hihat.volume.value = -12;
    hihat.set({
      envelope:{
        attack:0.005,
        decay:0.5,
        release:0.1
      },
      filterEnvelope:{
        release:0,
        min:6000,
        max:4000,
        exponent:2
        }
      });

    var scratch = new Tone.NoiseSynth().toMaster();
    scratch.set({
        noise: {
          type: 'white'
        },
        filter:{
          type:'lowpass'
        },
        filterEnvelope:{
          min:2000,
          max:0
        }
    });
    scratch.volume.value = -6;

    var defaultInstrument = organ;
    var instrument = defaultInstrument;

    

    // BLOCKLY SETUP
    var workspace = Blockly.inject('blocklyDiv',
        {
          media: '../../media/',
          toolbox: document.getElementById('toolbox'),
          scrollbars:true,
          trashcan: false
       });
    Blockly.Xml.domToWorkspace(workspace,
        document.getElementById('beatDemo'));

    function loadDemo(name) {
      workspace.clear();
      Blockly.Xml.domToWorkspace(workspace, document.getElementById(name));
    }

    var myInterpreter = null;

    function initApi(interpreter, scope) {

      // playFreq
      var wrapper = function(freq, duration, blockId) {
        freq = (Number(freq) > 0) ? Number(freq) : 200;
        duration = (Number(duration) > 0) ? Number(duration) : 0.5;
        blockId = blockId ? Number(blockId) : '0';
        return interpreter.createPrimitive(playFreq(freq, duration, blockId));
      };
      interpreter.setProperty(scope, 'playFreq',
          interpreter.createNativeFunction(wrapper));

      // playNote
      var wrapper = function(pitch, duration, blockId) {
        pitch = (Number(pitch) > 0) ? Number(pitch) : 60;
        duration = (Number(duration) > 0) ? Number(duration) : 0.5;
        blockId = blockId ? Number(blockId) : '0';
        return interpreter.createPrimitive(playNote(pitch, duration, blockId));
      };
      interpreter.setProperty(scope, 'playNote',
          interpreter.createNativeFunction(wrapper));

      // rest
      var wrapper = function(duration, blockId) {
        duration = (Number(duration) > 0) ? Number(duration) : 1;
        blockId = blockId ? Number(blockId) : '0';
        return interpreter.createPrimitive(rest(duration, blockId));
      };
      interpreter.setProperty(scope, 'rest',
          interpreter.createNativeFunction(wrapper));

      // playDrum
      var wrapper = function(name, duration, blockId) {
        duration = (Number(duration) > 0) ? Number(duration) : 1;
        blockId = blockId ? Number(blockId) : '0';
        return interpreter.createPrimitive(playDrum(name, duration, blockId));
      };
      interpreter.setProperty(scope, 'playDrum',
          interpreter.createNativeFunction(wrapper));

      // setInstrument
      var wrapper = function(name, blockId) {
        return interpreter.createPrimitive(setInstrument(name));
      };
      interpreter.setProperty(scope, 'setInstrument',
          interpreter.createNativeFunction(wrapper));

      // pickRandom
      var wrapper = function(min, max) {
        min = Number(min) ? Number(min) : 0;
        max = Number(max) ? Number(max) : 0;
        return interpreter.createPrimitive(pickRandom(min, max));
      };
      interpreter.setProperty(scope, 'pickRandom',
          interpreter.createNativeFunction(wrapper));

      // setTime - used internally
      var wrapper = function(time) {
        time = Number(time) ? Number(time) : 0;
        return interpreter.createPrimitive(setTime(time));
      };
      interpreter.setProperty(scope, 'setTime',
          interpreter.createNativeFunction(wrapper));

    }

    // TIMING!
    // the strategy is to pre-schedule all synth events for precise timing
    // scheduled block highlighting simulates stepping during playback, 
    // even though all the code runs in advance (only synth event blocks are highlighted)
    //
    // the assembled js code contains function calls for each synth event which include block ids
    // running the code in the interpreter results in populating a list of synth events
    // this list includes computed schedule times and block ids
    // finally, the events are scheduled: 
    // synth events are scheduled using tonejs i.e. web audio for very precise timing
    // block highlighting is scheduled with timeouts, not as precise but good enough

    var nextTime;
    var synthEvents = [];
    var secondsPerTick = 0.1;
      
    function playFreq(freq, duration, blockId) {
      var time = nextTime;
      duration *= secondsPerTick;
      nextTime += duration;
      var newEvent = {
        type: 'note',
        freq: freq,
        duration: duration,
        time: time,
        blockId: blockId
      };
      synthEvents.push(newEvent);
    }

    function playNote(pitch, duration, blockId) {
      var freq = midiToFreq(pitch);
      playFreq(freq, duration, blockId);
    }

    function rest(duration, blockId) {
      var time = nextTime;
      duration *= secondsPerTick;
      nextTime += duration;
     var newEvent = {
        type: 'rest',
        duration: duration,
        time: time,
        blockId: blockId
      };
      synthEvents.push(newEvent); 
    } 

    function playDrum(name, duration, blockId) {
      var time = nextTime;
      duration *= secondsPerTick;
      nextTime += duration;
      var newEvent = {
        type: 'drum',
        name: name,
        duration: duration,
        time: time,
        blockId: blockId
      }
      synthEvents.push(newEvent);
    }

    function midiToFreq(noteNum) {
      var noteName = tone.midiToNote(noteNum);
      return tone.noteToFrequency(noteName);
    }

    function setTime(time) {
      nextTime = time;
    }

    function setInstrument(name) {
      if (name) {
        name = name.toString();
      }
      var newEvent = {
        type: 'setInstrument',
        name: name
      }
      synthEvents.push(newEvent);
    }

    function setInstrumentEvent(name) {
      if (name) {
        // name = name.toString();
        if (name == 'SYNTH') {
          instrument = synth;
        }
       if (name == 'ORGAN') {
          instrument = organ;
        }
      } else {
        instrument = defaultInstrument;
      }
    }

    // function pickRandom(min, max) {
    //   var range = Math.abs(max - min);
    //   return (Math.random() * range) + min; 
    // }

    function scheduleSynthEvents() {

      instrument = defaultInstrument;

      for (var i=0; i<synthEvents.length; i++) {
        var time = synthEvents[i].time;
        var duration = synthEvents[i].duration;
        var blockId = synthEvents[i].blockId;

        switch (synthEvents[i].type) {
          case 'note':
            var freq = synthEvents[i].freq;
            instrument.triggerAttackRelease(freq, duration, '+' + time);
            highlightBlock(blockId, time, time + duration);
            break;
          case 'rest':
            // nothing to do
            highlightBlock(blockId, time, time + duration);
            break;
          case 'drum':
            var name = synthEvents[i].name;
            scheduleDrum(name, time);
            highlightBlock(blockId, time, time + duration);
            break;
          case 'setInstrument':
            setInstrumentEvent(synthEvents[i].name);
            break;
        }
      }
    }

    function scheduleDrum(name, time) {
      if (name == 'SNARE') {
        snare.triggerAttackRelease(0.25, '+' + time);
      }
      if (name == 'KICK') {
        kick.triggerAttackRelease('C2', 0.25, '+' + time);
      }
      if (name == 'HIHAT') {
        var velocity = (Math.random() * 0.5) + 0.5;
        hihat.triggerAttackRelease(0.01, '+' + time, velocity);
      }
      if (name == 'SCRATCH') {
        var velocity = (Math.random() * 0.5) + 0.5;
        scratch.triggerAttackRelease(0.1, '+' + time, velocity);
      }
    }

    // highlight using color changes, instead of built-in outline highlight
    // so we can highlight multiple blocks at a time
    function highlightBlock(id, timeOn, timeOff) {
      if (id != null) {
        window.setTimeout(function() {
          workspace.getBlockById(id).setColour(300);
        }, timeOn*1000);
        window.setTimeout(function() {
          workspace.getBlockById(id).setColour(Blockly.Blocks.synth.HUE);
        }, timeOff*1000);
      }
    } 

    function generateCode() {

      synthEvents = [];
      nextTime = 0;

      Blockly.JavaScript.init(workspace);

      // before each stack, reset the time
      // this allows multiple stacks to play in parallel
      var code = '';
      var stacks = workspace.getTopBlocks();
      for (var i=0; i<stacks.length; i++) {
        var stack = stacks[i];
        code += 'setTime(0);\n';
        code += 'setInstrument(null, null);\n';
        code += Blockly.JavaScript.blockToCode(stack);
      }

      // prepend variable and function definitions
      code = Blockly.JavaScript.finish(code);

      return code;

    }

    function runCode() {
      
      workspace.traceOn(true);
      workspace.highlightBlock(null);

      code = generateCode();

      myInterpreter = new Interpreter(code, initApi);
      myInterpreter.run(); // generate the schedule

      scheduleSynthEvents();
    }

    function logXML() {
      var xml = Blockly.Xml.workspaceToDom(workspace);
      var xml_text = Blockly.Xml.domToText(xml);
      console.log(xml_text);
    }

  </script>

</body>
</html>
